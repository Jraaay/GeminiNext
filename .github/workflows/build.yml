name: Build and Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify version consistency
        run: |
          TAG_VERSION="${GITHUB_REF_NAME#v}"
          PROJECT_VERSION=$(grep -m1 'MARKETING_VERSION' GeminiNext.xcodeproj/project.pbxproj | sed 's/.*= *\(.*\);/\1/' | tr -d ' ')
          echo "Tag version: $TAG_VERSION"
          echo "Project version: $PROJECT_VERSION"
          if [ "$TAG_VERSION" != "$PROJECT_VERSION" ]; then
            echo "::error::Version mismatch! Tag=$TAG_VERSION but project.pbxproj=$PROJECT_VERSION"
            echo "Please run: ./scripts/bump_version.sh $TAG_VERSION"
            exit 1
          fi

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_26.2.app || sudo xcode-select -s "$(ls -d /Applications/Xcode*.app | sort -V | tail -1)"

      - name: Resolve Swift Package Dependencies
        run: |
          xcodebuild -project GeminiNext.xcodeproj \
            -scheme "Gemini Next Desktop" \
            -resolvePackageDependencies

      - name: Build Universal Binary
        run: |
          xcodebuild -project GeminiNext.xcodeproj \
            -scheme "Gemini Next Desktop" \
            -configuration Release \
            -derivedDataPath build \
            ARCHS="arm64 x86_64" \
            ONLY_ACTIVE_ARCH=NO \
            CODE_SIGN_IDENTITY="-" \
            clean build

      - name: Create DMG
        run: |
          APP_PATH="build/Build/Products/Release/Gemini Next Desktop.app"
          DMG_NAME="GeminiNextDesktop-${{ github.ref_name }}.dmg"

          # Verify universal binary
          echo "Architectures:"
          lipo -info "$APP_PATH/Contents/MacOS/Gemini Next Desktop"

          # Re-sign the entire app bundle (including embedded Sparkle.framework) to ensure consistent Team ID
          codesign --deep --force --sign - "$APP_PATH"
          echo "Code signature verified:"
          codesign -dvvv "$APP_PATH"

          mkdir -p dmg_content
          cp -R "$APP_PATH" dmg_content/
          ln -s /Applications dmg_content/Applications

          hdiutil create -volname "Gemini Next Desktop" \
            -srcfolder dmg_content \
            -ov -format UDZO \
            "$DMG_NAME"

          echo "DMG_NAME=$DMG_NAME" >> $GITHUB_ENV

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: GeminiNextDesktop-universal
          path: ${{ env.DMG_NAME }}

  release:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/*.dmg
          generate_release_notes: true
          draft: true
          prerelease: false
